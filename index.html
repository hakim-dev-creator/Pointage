<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨ (V5.9 Visuals)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563EB">
    <link rel="manifest" href="manifest.json">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563EB; --bg: #F8FAFC; --surface: #FFFFFF;
            --success: #10B981; --danger: #EF4444; --warning: #F59E0B; --debt: #8B5CF6;
            --weekend: #FEFCE8; /* Ù„ÙˆÙ† Ø§Ù„Ø¹Ø·Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø£ØµÙØ± ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹) */
            --future: #E2E8F0;  /* Ù„ÙˆÙ† Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØºÙ„Ù‚Ø© (Ø±Ù…Ø§Ø¯ÙŠ) */
            --text-main: #1E293B; --text-sub: #64748B; --border: #E2E8F0;
            --radius: 16px; --shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { font-family: 'Tajawal', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 60px; }

        /* --- UI Styles --- */
        header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 20px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .app-title { font-size: 1.3rem; font-weight: 800; color: var(--primary); margin: 0; line-height: 1.2; }
        .app-subtitle { font-size: 0.8rem; color: var(--text-sub); font-weight: 500; }
        .status-badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 20px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; transition: all 0.3s ease; border: 1px solid transparent; }
        .app-logo { width: 40px; height: 40px; border-radius: 10px; object-fit: cover; box-shadow: var(--shadow); display: none; }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--surface); border-radius: var(--radius); padding: 15px; margin-bottom: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .month-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
        .btn-nav { background: var(--surface); border: 1px solid var(--border); width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .calendar-wrapper { overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .calendar-grid { display: grid; gap: 4px; min-width: max-content; }
        .cal-header-cell { padding: 6px; font-weight: 700; color: var(--text-sub); font-size: 0.85rem; text-align: center; background: #F1F5F9; border-radius: 6px; }
        .emp-name-cell { position: sticky; right: 0; z-index: 10; background: var(--surface); font-weight: 700; color: var(--primary); display: flex; align-items: center; padding: 0 8px; border-left: 2px solid var(--border); font-size: 0.9rem; }
        
        /* --- ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø®Ù„Ø§ÙŠØ§ --- */
        .day-cell { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; border-radius: 8px; background: #F8FAFC; color: var(--text-sub); transition: 0.1s; border: 1px solid transparent; }
        .day-cell:active { transform: scale(0.95); }
        
        /* 1. ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¹Ø·Ù„Ø© (Ø§Ù„Ø¬Ù…Ø¹Ø© ÙˆØ§Ù„Ø³Ø¨Øª) */
        .weekend-cell { background-color: var(--weekend); color: #854D0E; border: 1px dashed #FEF08A; }

        /* 2. Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± (ØªØ·ØºÙ‰ Ø¹Ù„Ù‰ Ù„ÙˆÙ† Ø§Ù„Ø¹Ø·Ù„Ø©) */
        .status-present { background: #DCFCE7 !important; color: #166534 !important; border: 1px solid #86EFAC !important; }
        .status-absent { background: #FEE2E2 !important; color: #991B1B !important; border: 1px solid #FECACA !important; }
        
        /* 3. Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© (Ø±Ù…Ø§Ø¯ÙŠ) */
        .cell-future { background-color: var(--future) !important; color: #94A3B8 !important; opacity: 0.5; cursor: not-allowed; border: none !important; }

        .btn { border: none; border-radius: 12px; padding: 12px; width: 100%; font-family: 'Tajawal', sans-serif; font-weight: 700; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15); }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15); }
        .btn-debt { background: var(--debt); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15); }
        .btn-warning { background: var(--warning); color: white; }
        .btn-ghost { background: #F1F5F9; color: var(--text-main); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; width: auto; }
        input, select { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Tajawal', sans-serif; font-size: 0.95rem; background: #fff; transition: 0.2s; outline: none; margin-bottom: 8px; }
        input:focus, select:focus { border-color: var(--primary); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .grid-full { grid-column: span 2; }
        .footer { text-align: center; margin-top: 25px; padding-top: 15px; border-top: 1px dashed var(--border); color: var(--text-sub); font-size: 0.8rem; }
        .designer-link { color: var(--primary); text-decoration: none; font-weight: 700; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(3px); z-index: 2000; align-items: flex-end; }
        .modal-content { background: var(--surface); width: 100%; max-width: 600px; margin: 0 auto; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { text-align: center; margin-bottom: 15px; }
        .modal-indicator { width: 35px; height: 4px; background: #E2E8F0; border-radius: 10px; margin: 0 auto 10px; }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: var(--text-main); margin: 0; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #F8FAFC; border-radius: 10px; margin-bottom: 6px; border: 1px solid var(--border); }
        .debt-tabs { background: #F1F5F9; padding: 4px; border-radius: 12px; display: flex; margin-bottom: 12px; }
        .debt-tab { flex: 1; text-align: center; padding: 8px; border-radius: 10px; font-weight: 700; color: var(--text-sub); cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .debt-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .debt-tab.active-out { color: var(--danger); }
        .pin-container { display: flex; justify-content: center; gap: 12px; margin: 25px 0; }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; background: #E2E8F0; transition: 0.2s; }
        .pin-dot.active { background: var(--primary); transform: scale(1.1); }
        .pin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; direction: ltr !important; margin-top: 10px; }
        #loader { position: fixed; inset: 0; background: var(--surface); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 35px; height: 35px; border: 3px solid #E2E8F0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- âœ¨ COMPACT MODERN DIALOGS âœ¨ --- */
        .dialog-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(2px); animation: fadeIn 0.2s; }
        .custom-dialog { 
            background: white; 
            width: 85%; 
            max-width: 320px;
            padding: 20px; 
            border-radius: 18px; 
            text-align: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            transform: scale(0.95); 
            animation: scaleUp 0.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { to { transform: scale(1); } }
        
        .dialog-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .dialog-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); margin: 0 0 5px 0; }
        .dialog-msg { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 15px; line-height: 1.4; }
        .dialog-input { font-size: 1.1rem; padding: 10px; text-align: center; margin-bottom: 15px; border: 2px solid var(--border); border-radius: 12px; background: #F8FAFC; color: var(--text-main); font-weight: bold; width: 100%; outline:none; transition:0.2s; }
        .dialog-input:focus { border-color: var(--primary); background: #fff; }
        .dialog-btns { display: flex; gap: 8px; justify-content: center; }
        .dialog-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-family: inherit; font-size: 0.9rem; transition: 0.1s; }
        .dialog-btn:active { transform: scale(0.96); }
        .btn-confirm { background: var(--primary); color: white; }
        .btn-cancel { background: #F1F5F9; color: var(--text-main); }
        .btn-delete { background: var(--danger); color: white; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:15px; font-weight:700; color:var(--text-sub); font-size:0.9rem">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p>
    <div id="errorMsg" style="color:var(--danger); display:none"></div>
</div>

<div id="msgDialog" class="dialog-overlay">
    <div class="custom-dialog">
        <span id="msgIcon" class="dialog-icon"></span>
        <h3 id="msgTitle" class="dialog-title"></h3>
        <p id="msgBody" class="dialog-msg"></p>
        <button class="dialog-btn btn-confirm" onclick="closeDialog('msgDialog')">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
</div>

<div id="confirmDialog" class="dialog-overlay">
    <div class="custom-dialog">
        <span class="dialog-icon">âœ‹</span> 
        <h3 id="confTitle" class="dialog-title"></h3>
        <p id="confBody" class="dialog-msg"></p>
        <div class="dialog-btns">
            <button id="confYesBtn" class="dialog-btn btn-delete">Ù†Ø¹Ù…</button>
            <button class="dialog-btn btn-cancel" onclick="closeDialog('confirmDialog')">ØªØ±Ø§Ø¬Ø¹</button>
        </div>
    </div>
</div>

<div id="promptDialog" class="dialog-overlay">
    <div class="custom-dialog">
        <span class="dialog-icon">âœï¸</span>
        <h3 id="promptTitle" class="dialog-title"></h3>
        <p id="promptBody" class="dialog-msg"></p>
        <input id="promptInput" type="number" class="dialog-input" placeholder="">
        <div class="dialog-btns">
            <button id="promptOkBtn" class="dialog-btn btn-confirm">ØªØ£ÙƒÙŠØ¯</button>
            <button class="dialog-btn btn-cancel" onclick="closeDialog('promptDialog')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>
<header>
    <div class="container" style="padding:0">
        <div class="header-content">
            <div>
                <h1 id="dispNameAr" class="app-title">Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨</h1>
                <div id="dispNameFr" class="app-subtitle">Online System</div>
            </div>
            <div style="text-align: left;">
                <img id="displayLogo" class="app-logo" src="" alt="Logo">
                <div id="connStatus" class="status-badge" style="background:#E2E8F0; color:#64748B;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>
            </div>
        </div>
    </div>
</header>

<div id="contentArea" class="container" style="display:none">
    <div class="card">
        <div class="calendar-controls">
            <button onclick="changeMonth(-1)" class="btn-nav">â€¹</button>
            <div id="monthLabel" class="month-title"></div>
            <button onclick="changeMonth(1)" class="btn-nav">â€º</button>
        </div>
        <div class="calendar-wrapper"><div id="calendarGrid" class="calendar-grid"></div></div>
    </div>
    <div class="card">
        <div style="font-weight:700; margin-bottom:10px; color:var(--text-main); font-size:0.95rem">ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø³Ø±ÙŠØ¹</div>
        <div style="display:flex; gap:8px;">
            <select id="waEmpSelect" style="margin:0"><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option></select>
            <button onclick="sendWAReport()" class="btn btn-success btn-sm" style="width:auto">ÙˆØ§ØªØ³Ø§Ø¨</button>
        </div>
    </div>
    <div class="dashboard-grid">
        <button class="btn btn-primary" onclick="openAdvancesModal()"><span>ğŸ’°</span> Ø§Ù„ØªØ³Ø¨ÙŠÙ‚Ø§Øª</button>
        <button class="btn btn-debt" onclick="openDebtsModal()"><span>ğŸ“’</span> Ø§Ù„Ø¯ÙŠÙˆÙ†</button>
        <button class="btn btn-ghost grid-full" onclick="openSettingsModal()"><span>âš™ï¸</span> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
    <div class="footer"><div>Designed & Developed by</div><a href="#" id="designerLink" class="designer-link" onclick="contactDesigner()">Ahmed Tech</a></div>
</div>

<div id="pinModal" class="modal" style="z-index:4000; align-items:center;">
    <div class="modal-content" style="border-radius:24px; text-align:center;">
        <h3 class="modal-title">ğŸ”’ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <p style="color:var(--text-sub); margin-top:5px; font-size:0.9rem">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <div id="dotsContainer" class="pin-container"></div>
        <div class="pin-grid">
            <button onclick="pressPin('1')" class="btn btn-ghost" style="font-size:1.4rem">1</button>
            <button onclick="pressPin('2')" class="btn btn-ghost" style="font-size:1.4rem">2</button>
            <button onclick="pressPin('3')" class="btn btn-ghost" style="font-size:1.4rem">3</button>
            <button onclick="pressPin('4')" class="btn btn-ghost" style="font-size:1.4rem">4</button>
            <button onclick="pressPin('5')" class="btn btn-ghost" style="font-size:1.4rem">5</button>
            <button onclick="pressPin('6')" class="btn btn-ghost" style="font-size:1.4rem">6</button>
            <button onclick="pressPin('7')" class="btn btn-ghost" style="font-size:1.4rem">7</button>
            <button onclick="pressPin('8')" class="btn btn-ghost" style="font-size:1.4rem">8</button>
            <button onclick="pressPin('9')" class="btn btn-ghost" style="font-size:1.4rem">9</button>
            <button onclick="clearPin()" class="btn btn-danger" style="font-size:0.9rem; background:#fee2e2; color:#ef4444;">C</button>
            <button onclick="pressPin('0')" class="btn btn-ghost" style="font-size:1.4rem">0</button>
            <button onclick="backspacePin()" class="btn btn-ghost" style="font-size:1.1rem; color:#f59e0b;">âŒ«</button>
        </div>
    </div>
</div>

<div id="attModal" class="modal">
    <div class="modal-content">
        <div class="modal-indicator"></div>
        <div class="modal-header"><h3 id="attEmpName" class="modal-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h3></div>
        <div style="background:#F8FAFC; padding:15px; border-radius:12px; margin-bottom:20px;">
            <label style="font-size:0.85rem; font-weight:600">ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±</label>
            <div style="display:flex; gap:10px; margin-bottom:12px"><input type="time" id="tIn" value="08:00" style="margin:0"><button class="btn btn-warning btn-sm" onclick="setSmartNow('tIn')">Ø§Ù„Ø¢Ù†</button></div>
            <label style="font-size:0.85rem; font-weight:600">ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</label>
            <div style="display:flex; gap:10px"><input type="time" id="tOut" value="16:00" style="margin:0"><button class="btn btn-warning btn-sm" onclick="setSmartNow('tOut')">Ø§Ù„Ø¢Ù†</button></div>
        </div>
        <button class="btn btn-success" onclick="saveAtt('full')" style="margin-bottom:8px">âœ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ§Ù…</button>
        <button class="btn btn-danger" onclick="saveAtt('absent')" style="margin-bottom:8px">âŒ ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨</button>
        <button class="btn btn-ghost" onclick="closeM('attModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="advModal" class="modal"><div class="modal-content"><div class="modal-indicator"></div><div class="modal-header"><h3 class="modal-title">ğŸ’° Ø§Ù„ØªØ³Ø¨ÙŠÙ‚Ø§Øª</h3></div><div id="advListArea" style="max-height:400px; overflow-y:auto; padding-bottom:20px;"></div><button class="btn btn-ghost" onclick="closeM('advModal')">Ø¥ØºÙ„Ø§Ù‚</button></div></div>

<div id="debtModal" class="modal">
    <div class="modal-content">
        <div class="modal-indicator"></div>
        <div class="modal-header"><h3 class="modal-title">ğŸ“’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†</h3></div>
        <div class="debt-tabs"><div id="tabIn" class="debt-tab active" onclick="switchDebtTab('in')">ğŸ“¥ Ø¯ÙŠÙˆÙ† Ù„Ù„ØªØ­ØµÙŠÙ„</div><div id="tabOut" class="debt-tab" onclick="switchDebtTab('out')">ğŸ“¤ Ø¯ÙŠÙˆÙ† Ù„Ù„ØªØ³Ø¯ÙŠØ¯</div></div>
        <div style="background:#F8FAFC; padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border)"><input id="debtName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†/Ø§Ù„Ø¯Ø§Ø¦Ù†" style="margin-top:0"><div style="display:flex; gap:10px"><input id="debtVal" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="margin:0"><button class="btn btn-debt" onclick="addDebt()" style="width:auto; padding:0 15px; font-size:1.2rem">+</button></div><div style="font-size:0.7rem; color:var(--text-sub); text-align:center; margin-top:5px">ğŸ•’ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div></div>
        <div id="debtListIn" style="max-height:300px; overflow-y:auto; display:none;"></div><div id="debtListOut" style="max-height:300px; overflow-y:auto; display:none;"></div>
        <button class="btn btn-ghost" onclick="closeM('debtModal')" style="margin-top:10px">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-indicator"></div>
        <div class="modal-header"><h3 class="modal-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3></div>
        <div class="card" style="padding:15px; margin-bottom:15px">
            <h4 style="margin:0 0 8px 0; color:var(--primary); font-size:0.95rem">ğŸ¢ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h4>
            <input id="inputCompName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
            <input id="inputCompNameFr" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©">
            <label style="font-size:0.8rem; margin-bottom:5px; display:block">Ø§Ù„Ø´Ø¹Ø§Ø±:</label><input type="file" id="inputLogo" accept="image/*" onchange="handleLogoUpload(this)">
            <h4 style="margin:12px 0 8px 0; color:var(--text-sub); font-size:0.9rem">ğŸ¨ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…ØµÙ…Ù… (Footer)</h4>
            <input id="inputDesigner" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµÙ…Ù… (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„)">
            <input id="inputPhone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…ØµÙ…Ù… (Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨)">
            <button class="btn btn-primary btn-sm" onclick="saveCompanySettings()">Ø­ÙØ¸</button>
        </div>
        <h4 style="margin-bottom:10px; font-size:0.95rem">ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
        <div id="empsList" style="max-height:180px; overflow-y:auto; margin-bottom:15px"></div>
        <div style="display:flex; gap:8px; margin-bottom:10px"><input id="newE" placeholder="Ø§Ù„Ø§Ø³Ù…" style="margin:0"><input id="newR" type="number" placeholder="Ø§Ù„Ø£Ø¬Ø±" style="width:70px; margin:0"></div>
        <button class="btn btn-success" onclick="addEmployee()">â• Ø¥Ø¶Ø§ÙØ©</button>
        <hr style="border-top:1px solid var(--border); margin:15px 0">
        <div style="background:#fff; padding:12px; border-radius:12px; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;"><span style="font-weight:700; font-size:0.9rem">ğŸ” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ</span><label class="switch"><input type="checkbox" id="pinToggle" onchange="togglePin(this)"><span class="slider"></span></label></div>
        <div style="display:flex; gap:8px"><input type="password" id="p1" maxlength="4" placeholder="Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù…)" style="margin:0"><button class="btn btn-primary btn-sm" onclick="updatePin()">ØªØ­Ø¯ÙŠØ«</button></div>
        <button class="btn btn-ghost" onclick="closeM('settingsModal')" style="margin-top:15px">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
const firebaseConfig = {
    apiKey: "AIzaSyAvM0V2tjyPfIV2iwkyGxyfMWh_T_hqq74",
    authDomain: "pointage-af939.firebaseapp.com",
    projectId: "pointage-af939",
    storageBucket: "pointage-af939.firebasestorage.app",
    messagingSenderId: "265434883388",
    appId: "1:265434883388:web:43b87f6671d4e446d7aa39",
    measurementId: "G-VEZH7GMRG2"
  };

    if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("Ø¶Ø¹_ÙƒÙˆØ¯")) {
        document.getElementById('errorMsg').style.display = 'block';
        document.getElementById('errorMsg').innerText = "âš ï¸ Ø®Ø·Ø£: ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ ÙƒÙˆØ¯ Firebase Config Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ!";
        throw new Error("Missing Config");
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    try { enableIndexedDbPersistence(db).catch((err) => { console.log("Persistence error", err); }); } catch(e) {}
    const mainDocRef = doc(db, "salary_system", "main_data");

    let appData = { emps: [], att: {}, advances: {}, debts: { in: [], out: [] }, companyName: "Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨", companyNameFr: "Online System", logo: null, pin: "0000", pinEnabled: true, designerName: "Ahmed Tech", designerPhone: "" };
    let currDate = new Date();
    let sel = null;
    let pinIn = "";
    let currentDebtTab = 'in';

    // --- âœ¨ COMPACT DIALOGS FUNCTIONS âœ¨ ---
    window.showMsg = (title, text, type) => {
        document.getElementById('msgTitle').innerText = title;
        document.getElementById('msgBody').innerText = text;
        document.getElementById('msgIcon').innerText = type === 'success' ? 'âœ¨' : (type === 'error' ? 'âš ï¸' : 'ğŸ””');
        document.getElementById('msgDialog').style.display = 'flex';
    };

    window.showConfirm = (title, text, callback) => {
        document.getElementById('confTitle').innerText = title;
        document.getElementById('confBody').innerText = text;
        document.getElementById('confirmDialog').style.display = 'flex';
        document.getElementById('confYesBtn').onclick = () => { closeDialog('confirmDialog'); callback(); };
    };

    window.showPrompt = (title, text, placeholder, callback) => {
        document.getElementById('promptTitle').innerText = title;
        document.getElementById('promptBody').innerText = text;
        const inp = document.getElementById('promptInput');
        inp.value = "";
        inp.placeholder = placeholder || "";
        document.getElementById('promptDialog').style.display = 'flex';
        setTimeout(() => inp.focus(), 100);
        document.getElementById('promptOkBtn').onclick = () => { 
            closeDialog('promptDialog'); 
            if(inp.value) callback(inp.value); 
        };
    };

    window.closeDialog = (id) => document.getElementById(id).style.display = 'none';
    // ----------------------------------------

    function updateStatus(state) {
        const el = document.getElementById('connStatus');
        el.className = "status-badge"; el.style.background = ""; el.style.color = "";
        if(!navigator.onLine || state === "offline") {
            el.innerText = "Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ ğŸ’¾"; el.style.background = "#FFEDD5"; el.style.color = "#9A3412"; el.style.border = "1px solid #FED7AA"; return;
        }
        if(state === "server") { el.innerText = "ØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨Ø© â˜ï¸"; el.style.background = "#D1FAE5"; el.style.color = "#065F46"; } 
        else if(state === "cache") { el.innerText = "Ø¨Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ğŸ’¾"; el.style.background = "#FFEDD5"; el.style.color = "#9A3412"; } 
        else if(state === "sync") { el.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹... â³"; el.style.background = "#FEF3C7"; el.style.color = "#92400E"; } 
        else { el.innerText = "Ø®Ø·Ø£ âŒ"; el.style.background = "#FEE2E2"; el.style.color = "#991B1B"; }
    }
    window.addEventListener('online',  () => updateStatus("sync"));
    window.addEventListener('offline', () => updateStatus("offline"));

    const getNowStr = () => { let n = new Date(); return `${n.toLocaleDateString('ar-DZ')} ${n.getHours()}:${n.getMinutes().toString().padStart(2,'0')}`; };
    function calcDuration(start, end) { if(!start || !end) return 0; let [h1, m1] = start.split(':').map(Number); let [h2, m2] = end.split(':').map(Number); let diff = (h2 * 60 + m2) - (h1 * 60 + m1); if (diff < 0) diff += 24 * 60; return diff; }
    function minsToTime(mins) { let h = Math.floor(mins / 60); let m = mins % 60; return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; }

    window.setupDots = (n) => document.getElementById('dotsContainer').innerHTML = Array(n).fill('<div class="pin-dot"></div>').join('');
    window.updateDots = () => document.querySelectorAll('.pin-dot').forEach((d, i) => d.className = i < pinIn.length ? 'pin-dot active' : 'pin-dot');
    window.pressPin = (n) => { if(pinIn.length < 4) { pinIn += n; updateDots(); if(pinIn.length === 4) checkPin(); } };
    window.backspacePin = () => { pinIn = pinIn.slice(0, -1); updateDots(); };
    window.clearPin = () => { pinIn = ""; updateDots(); };
    function checkPin() {
        if(pinIn === appData.pin || pinIn === "10031945") { unlockApp(); clearPin(); } else { showMsg("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­", "error"); clearPin(); }
    }
    function unlockApp() { document.getElementById('pinModal').style.display = 'none'; document.getElementById('contentArea').style.display = 'block'; }
    setupDots(4);

    onSnapshot(mainDocRef, { includeMetadataChanges: true }, (docSnap) => {
        document.getElementById('loader').style.display = 'none';
        const source = docSnap.metadata.fromCache ? "cache" : "server";
        if(!navigator.onLine) { updateStatus("offline"); } else { updateStatus(source); }
        if (docSnap.exists()) {
            let d = docSnap.data();
            appData = { ...appData, ...d };
            if(appData.pinEnabled === undefined) appData.pinEnabled = true; 
            if(appData.pinEnabled === false) { unlockApp(); } else { if(document.getElementById('contentArea').style.display === 'none') document.getElementById('pinModal').style.display = 'flex'; }
            if(Array.isArray(appData.debts)) appData.debts = { in: appData.debts, out: [] };
            if(!appData.debts) appData.debts = { in: [], out: [] };
            applyIdentity(); renderCalendar(); updateWASelect();
            if(document.getElementById('debtModal').style.display === 'flex') renderDebtList();
            if(document.getElementById('settingsModal').style.display === 'flex') window.openSettingsModal(); 
        } else { saveToFirebase(); }
    }, (e) => { document.getElementById('loader').style.display = 'none'; updateStatus("error"); });

    async function saveToFirebase() {
        if(navigator.onLine) updateStatus("sync");
        try { await setDoc(mainDocRef, appData); } catch(e) { updateStatus("cache"); } 
    }

    function applyIdentity() {
        if(appData.companyName) document.getElementById('dispNameAr').innerText = appData.companyName;
        if(appData.companyNameFr) document.getElementById('dispNameFr').innerText = appData.companyNameFr;
        if(appData.logo) { document.getElementById('displayLogo').src = appData.logo; document.getElementById('displayLogo').style.display = 'block'; }
        document.getElementById('designerLink').innerText = appData.designerName || "Ahmed Tech";
        window.contactDesigner = () => { if(appData.designerPhone) window.open(`https://wa.me/${appData.designerPhone}`, '_blank'); };
    }

    window.changeMonth = (n) => { currDate.setMonth(currDate.getMonth() + n); renderCalendar(); }
    function renderCalendar() {
        const months = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        document.getElementById('monthLabel').innerText = months[currDate.getMonth()] + " " + currDate.getFullYear();
        const grid = document.getElementById('calendarGrid');
        const days = new Date(currDate.getFullYear(), currDate.getMonth()+1, 0).getDate();
        grid.style.gridTemplateColumns = `120px repeat(${days}, 45px)`; 
        let h = '<div class="cal-header-cell">Ø§Ù„Ù…ÙˆØ¸Ù</div>';
        for(let d=1; d<=days; d++) h += `<div class="cal-header-cell">${d}</div>`;
        grid.innerHTML = h;
        let today = new Date(); today.setHours(0,0,0,0);
        if(appData.emps) {
            appData.emps.forEach(e => {
                let nc = document.createElement('div'); nc.className = "emp-name-cell"; nc.innerText = e.name; grid.appendChild(nc);
                for(let d=1; d<=days; d++) {
                    let k = `${currDate.getFullYear()}-${currDate.getMonth()}-${d}-${e.id}`;
                    let cellDate = new Date(currDate.getFullYear(), currDate.getMonth(), d);
                    
                    // 1. ØªØ­Ø¯ÙŠØ¯ Ù‡Ù„ Ø§Ù„ÙŠÙˆÙ… Ø¹Ø·Ù„Ø© (Ø¬Ù…Ø¹Ø© Ø£Ùˆ Ø³Ø¨Øª)
                    let dayOfWeek = cellDate.getDay(); // 5 = Ø§Ù„Ø¬Ù…Ø¹Ø©ØŒ 6 = Ø§Ù„Ø³Ø¨Øª
                    let isWeekend = (dayOfWeek === 5 || dayOfWeek === 6);

                    let isFuture = cellDate > today;
                    let r = appData.att[k], cls = "day-cell", txt = "-";
                    
                    // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¹Ø·Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ø¬Ù…Ø¹Ø© Ø£Ùˆ Ø³Ø¨Øª
                    if(isWeekend) cls += " weekend-cell";

                    if(r) { 
                        if(r.status === 'full') { 
                            cls += " status-present"; // Ø³ÙŠØ·ØºÙ‰ Ø¹Ù„Ù‰ Ù„ÙˆÙ† Ø§Ù„Ø¹Ø·Ù„Ø© Ø¨Ø³Ø¨Ø¨ !important
                            if(r.tIn && r.tOut) { let mins = calcDuration(r.tIn, r.tOut); txt = minsToTime(mins); } else { txt = "âœ”"; } 
                        } 
                        else { cls += " status-absent"; txt = "âœ–"; } 
                    }
                    let c = document.createElement('div'); c.className = cls; c.innerText = txt;
                    
                    if(isFuture) { 
                        c.className += " cell-future"; // Ø³ÙŠØ·ØºÙ‰ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙˆÙŠØµØ¨Ø­ Ø±Ù…Ø§Ø¯ÙŠ
                        c.onclick = () => showMsg("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ£Ø´ÙŠØ± Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹", "info"); 
                    } 
                    else { c.onclick = () => openAttModal(e, k); }
                    grid.appendChild(c);
                }
            });
        }
    }

    window.openAttModal = (e, k) => { sel = { e, k }; document.getElementById('attEmpName').innerText = e.name; document.getElementById('attModal').style.display = 'flex'; if(appData.att[k] && appData.att[k].status === 'full') { document.getElementById('tIn').value = appData.att[k].tIn || "08:00"; document.getElementById('tOut').value = appData.att[k].tOut || "16:00"; } }
    window.setSmartNow = (id) => { let parts = sel.k.split('-'); let selDate = new Date(parts[0], parts[1], parts[2]); let today = new Date(); today.setHours(0,0,0,0); if(selDate.getTime() !== today.getTime()) { showMsg("ØªØ°ÙƒÙŠØ±", "Ø²Ø± 'Ø§Ù„Ø¢Ù†' Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·", "info"); return; } let d = new Date(); document.getElementById(id).value = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0'); }
    window.saveAtt = (s) => { let tIn = document.getElementById('tIn').value; let tOut = document.getElementById('tOut').value; let workMins = 0; if(s === 'full') { workMins = calcDuration(tIn, tOut); appData.att[sel.k] = { status: 'full', tIn: tIn, tOut: tOut, workMins: workMins }; } else { appData.att[sel.k] = { status: 'absent' }; } saveToFirebase(); closeM('attModal'); }
    window.openAdvancesModal = () => { const a = document.getElementById('advListArea'), mk = `${currDate.getFullYear()}-${currDate.getMonth()}`; if(!appData.advances[mk]) appData.advances[mk] = {}; a.innerHTML = appData.emps.map(e => { let list = appData.advances[mk][e.id] || [], total = list.reduce((acc, item) => acc + (item.val || item), 0); let itemsHtml = list.map((item, idx) => { let val = item.val || item; let dateStr = item.dateStr || ""; return `<div class="list-item" style="padding:8px"><span><b>${val} Ø¯Ø¬</b> <span style="font-size:0.75rem; color:#888; margin-right:5px">ğŸ•’ ${dateStr}</span></span><span style="color:var(--danger); cursor:pointer" onclick="delAdv('${e.id}', ${idx})">ğŸ—‘ï¸</span></div>`; }).join(''); return `<div class="card" style="padding:15px; margin-bottom:10px;"><div style="display:flex; justify-content:space-between; margin-bottom:10px"><b style="font-size:1.1rem">${e.name}</b> <span style="color:var(--debt); font-weight:800; background:#F3E8FF; padding:4px 10px; border-radius:8px">${total} Ø¯Ø¬</span></div><div class="row-now"><input type="number" id="adv_${e.id}" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"><button onclick="addAdvance('${e.id}')" class="btn btn-primary btn-sm">+</button></div>${itemsHtml}</div>`; }).join(''); document.getElementById('advModal').style.display = 'flex'; }
    
    // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ³Ø¨ÙŠÙ‚ "Ø§Ù„Ù„Ø·ÙŠÙØ©"
    window.addAdvance = (eid) => { 
        let inputEl = document.getElementById(`adv_${eid}`);
        let v = inputEl.value; 
        if(!v || Number(v) <= 0) { 
            showMsg("ØªØ°ÙƒÙŠØ±", "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙˆÙ„Ø§Ù‹", "info"); 
            return; 
        } 
        const mk = `${currDate.getFullYear()}-${currDate.getMonth()}`; 
        if(!appData.advances[mk]) appData.advances[mk] = {}; 
        if(!appData.advances[mk][eid]) appData.advances[mk][eid] = []; 
        appData.advances[mk][eid].push({ val: Number(v), dateStr: getNowStr() }); 
        saveToFirebase(); 
        openAdvancesModal(); 
    }

    window.delAdv = (eid, idx) => { showConfirm("Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù„Øº", "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ", () => { const mk = `${currDate.getFullYear()}-${currDate.getMonth()}`; appData.advances[mk][eid].splice(idx, 1); saveToFirebase(); openAdvancesModal(); }); }
    window.openDebtsModal = () => { switchDebtTab('in'); document.getElementById('debtModal').style.display = 'flex'; }
    window.switchDebtTab = (t) => { currentDebtTab = t; document.getElementById('tabIn').className = t === 'in' ? 'debt-tab active' : 'debt-tab'; document.getElementById('tabOut').className = t === 'out' ? 'debt-tab active-out' : 'debt-tab'; document.getElementById('debtListIn').style.display = t === 'in' ? 'block' : 'none'; document.getElementById('debtListOut').style.display = t === 'out' ? 'block' : 'none'; renderDebtList(); }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† "Ø§Ù„Ù„Ø·ÙŠÙØ©"
    window.addDebt = () => { 
        let n = document.getElementById('debtName').value.trim(); 
        let v = document.getElementById('debtVal').value; 
        if(!n && !v) { 
            let msg = currentDebtTab === 'in' ? "Ø§Ù„Ù…Ø±Ø¬Ùˆ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº" : "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø¦Ù† ÙˆØ§Ù„Ù…Ø¨Ù„Øº"; 
            showMsg("Ø¹ÙÙˆØ§Ù‹", msg, "error"); return; 
        }
        if(!n) { 
            let msg = currentDebtTab === 'in' ? "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†ØŸ" : "Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø¯Ø§Ø¦Ù†ØŸ"; 
            showMsg("Ø§Ù„Ø§Ø³Ù… Ù…ÙÙ‚ÙˆØ¯", msg, "error"); return; 
        }
        if(!v) { 
            showMsg("Ø§Ù„Ù…Ø¨Ù„Øº Ù…ÙÙ‚ÙˆØ¯", "ÙƒÙ… Ù‡Ùˆ Ø§Ù„Ù…Ø¨Ù„ØºØŸ", "error"); return; 
        }
        appData.debts[currentDebtTab].push({ id: Date.now(), name: n, total: Number(v), remaining: Number(v), dateStr: getNowStr(), status: 'active' }); 
        saveToFirebase(); 
        document.getElementById('debtName').value=""; document.getElementById('debtVal').value=""; renderDebtList(); 
    }
    function renderDebtList() { let list = appData.debts[currentDebtTab], container = document.getElementById(currentDebtTab === 'in' ? 'debtListIn' : 'debtListOut'); if(list.length === 0) { container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px; font-size:0.9rem'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†</p>"; return; } container.innerHTML = list.map((d, i) => { let total = d.total || d.val || 0, remaining = d.remaining !== undefined ? d.remaining : total, isPaid = remaining <= 0; return `<div class="list-item" style="flex-direction:column; align-items:stretch"><div style="display:flex; justify-content:space-between; align-items:center"><div><div style="font-weight:700; font-size:0.95rem">${d.name}</div><div style="font-size:0.7rem; color:#777">ğŸ“… ${d.dateStr||d.date||""}</div></div><div class="debt-amount ${isPaid ? 'debt-paid' : ''}">${remaining} Ø¯Ø¬</div></div>${!isPaid ? `<div style="display:flex; justify-content:space-between; margin-top:8px; align-items:center"><span style="font-size:0.75rem; color:#555">Ø§Ù„Ø£ØµÙ„: ${total}</span><div style="display:flex; gap:8px"><button class="btn btn-success btn-sm" onclick="settleDebt('${currentDebtTab}', ${i})">ØªØ³Ø¯ÙŠØ¯</button><span style="color:var(--danger); cursor:pointer; align-self:center" onclick="deleteDebt('${currentDebtTab}', ${i})">ğŸ—‘ï¸</span></div></div>` : `<div style="text-align:left; margin-top:5px; color:var(--success); font-weight:700; font-size:0.85rem">âœ… Ø®Ø§Ù„Øµ <span style="font-size:0.75rem; color:var(--danger); cursor:pointer; margin-right:8px" onclick="deleteDebt('${currentDebtTab}', ${i})">Ø­Ø°Ù</span></div>`}</div>`; }).join(''); }
    window.settleDebt = (type, i) => { let d = appData.debts[type][i]; if(d.remaining === undefined) d.remaining = d.total || d.val; showPrompt("ØªØ³Ø¯ÙŠØ¯", `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${d.remaining} Ø¯Ø¬\nÙƒÙ… ØªØ±ÙŠØ¯ Ø§Ù„ØªØ³Ø¯ÙŠØ¯ØŸ`, "3000", (pay) => { let amt = Number(pay); if(amt > 0 && amt <= d.remaining) { d.remaining -= amt; if(d.remaining === 0) d.status = 'paid'; saveToFirebase(); renderDebtList(); } else showMsg("Ø¹ÙÙˆØ§Ù‹", "Ø§Ù„Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©", "error"); }); }
    window.deleteDebt = (t, i) => { showConfirm("Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ", () => { appData.debts[t].splice(i, 1); saveToFirebase(); renderDebtList(); }); }
    window.openSettingsModal = () => { const l = document.getElementById('empsList'); l.innerHTML = ""; document.getElementById('inputCompName').value = appData.companyName || ""; document.getElementById('inputCompNameFr').value = appData.companyNameFr || ""; document.getElementById('inputDesigner').value = appData.designerName || ""; document.getElementById('inputPhone').value = appData.designerPhone || ""; document.getElementById('pinToggle').checked = appData.pinEnabled !== false; if(appData.emps) appData.emps.forEach((e, i) => { l.innerHTML += `<div class="list-item"><span><b>${e.name}</b> (${e.rate} Ø¯Ø¬) <span onclick="updateEmpRate(${i})" style="cursor:pointer; background:#EFF6FF; padding:2px 6px; border-radius:4px; font-size:0.8rem; color:var(--primary)">âœï¸</span></span><span style="color:var(--danger); cursor:pointer" onclick="deleteEmp(${i})">ğŸ—‘ï¸</span></div>`; }); document.getElementById('settingsModal').style.display = 'flex'; }
    window.updateEmpRate = (i) => { let e = appData.emps[i]; showPrompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¬Ø±", `Ø§Ù„Ù…ÙˆØ¸Ù: ${e.name}`, e.rate, (newRate) => { if(newRate && newRate > 0) { appData.emps[i].rate = Number(newRate); saveToFirebase(); openSettingsModal(); } }); }
    window.togglePin = (checkbox) => { appData.pinEnabled = checkbox.checked; saveToFirebase(); showMsg("ØªÙ…", appData.pinEnabled ? "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚ÙÙ„" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„", "success"); }
    window.addEmployee = () => { let n = document.getElementById('newE').value, r = document.getElementById('newR').value; if(n && r) { appData.emps.push({ id: Date.now(), name: n, rate: Number(r) }); saveToFirebase(); document.getElementById('newE').value = ""; openSettingsModal(); } }
    window.deleteEmp = (i) => { showConfirm("Ø­Ø°Ù Ù…ÙˆØ¸Ù", "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙ‡. Ù…ØªØ£ÙƒØ¯ØŸ", () => { appData.emps.splice(i, 1); saveToFirebase(); openSettingsModal(); }); }
    window.saveCompanySettings = () => { appData.companyName = document.getElementById('inputCompName').value; appData.companyNameFr = document.getElementById('inputCompNameFr').value; appData.designerName = document.getElementById('inputDesigner').value; appData.designerPhone = document.getElementById('inputPhone').value; if(window.tempLogo) appData.logo = window.tempLogo; saveToFirebase(); showMsg("ØªÙ…", "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "success"); applyIdentity(); }
    window.handleLogoUpload = (i) => { if(i.files && i.files[0]) { var r = new FileReader(); r.onload = (e) => window.tempLogo = e.target.result; r.readAsDataURL(i.files[0]); } }
    window.updatePin = () => { let p = document.getElementById('p1').value; if(p.length === 4) { appData.pin = p; appData.pinEnabled = true; saveToFirebase(); showMsg("ØªÙ…", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…Ø²", "success"); document.getElementById('p1').value=""; document.getElementById('pinToggle').checked = true; } else { showMsg("Ø¹ÙÙˆØ§Ù‹", "ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ù…Ø² 4 Ø£Ø±Ù‚Ø§Ù…", "error"); } }
    window.closeM = (id) => document.getElementById(id).style.display = 'none';
    function updateWASelect() { let s = document.getElementById('waEmpSelect'); s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù --</option>'; if(appData.emps) appData.emps.forEach(e => s.innerHTML += `<option value="${e.id}">${e.name}</option>`); }
    window.sendWAReport = () => { let eid = document.getElementById('waEmpSelect').value; if(!eid) return showMsg("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù", "info"); let e = appData.emps.find(x => x.id == eid), days = 0, mk = `${currDate.getFullYear()}-${currDate.getMonth()}`, dim = new Date(currDate.getFullYear(), currDate.getMonth()+1, 0).getDate(); let totalMins = 0; for(let d=1; d<=dim; d++) { let r = appData.att[`${currDate.getFullYear()}-${currDate.getMonth()}-${d}-${eid}`]; if(r && r.status === 'full') { days++; let mins = r.workMins || (r.tIn && r.tOut ? calcDuration(r.tIn, r.tOut) : 480); totalMins += mins; } } let totalHoursStr = minsToTime(totalMins); let advList = appData.advances[mk] && appData.advances[mk][eid] ? appData.advances[mk][eid] : []; let adv = advList.reduce((acc, item) => acc + (item.val || item), 0); let sal = days * e.rate; let msg = `*ÙƒØ´Ù: ${e.name}*\nğŸ—“ï¸ ${document.getElementById('monthLabel').innerText}\nâœ… Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„: ${days}\nâ± Ø§Ù„Ø³Ø§Ø¹Ø§Øª: ${totalHoursStr}\nğŸ’µ Ù…Ø³ØªØ­Ù‚: ${sal} Ø¯Ø¬\nğŸ’¸ Ø³Ø­Ø¨: ${adv} Ø¯Ø¬\nğŸ’° *ØµØ§ÙÙŠ: ${sal - adv} Ø¯Ø¬*`; window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank'); }
</script>
</body>
</html>
